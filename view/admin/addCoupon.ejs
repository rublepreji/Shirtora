<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirtora - Add Coupon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .error-msg { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; display: block; }
        input.error-border { border: 1px solid #ef4444 !important; }
    </style>
</head>
<body class="bg-white text-gray-800">

    <div class="flex min-h-screen">
        
        <!-- Sidebar -->
        <aside class="hidden md:flex flex-col w-64 bg-white border-r border-gray-100 p-6 space-y-6">
            

            <%-include("../../view/partials/admin/sideBar")%>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 md:p-12 lg:p-16">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-2xl font-bold">Add coupon</h2>
            </div>

            <form id="couponForm" class="max-w-4xl" novalidate>
                <div id="formGeneralError" class="mb-4 text-red-500 text-sm font-medium"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                    
                    <!-- Coupon Code -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium">Coupon Code</label>
                            <input type="text" id="couponCode" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="couponCodeError" class="error-msg md:ml-40"></span>
                    </div>

                    <!-- Discount -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium">Discount (%):</label>
                            <input type="number" id="discount" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="discountError" class="error-msg md:ml-40"></span>
                    </div>

                     <!-- Maximum UPTO -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium leading-tight">UPTO (Max Discount):</label>
                            <input type="number" id="upto" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="uptoError" class="error-msg md:ml-40"></span>
                    </div>

                    <!-- Total usage limit -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium">Total usage limit:</label>
                            <input type="number" id="totalLimit" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="totalLimitError" class="error-msg md:ml-40"></span>
                    </div>

                    <!-- Per user limit -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium">Per user limit:</label>
                            <input type="number" id="perUserLimit" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="perUserLimitError" class="error-msg md:ml-40"></span>
                    </div>

                    <!-- Minimum purchase amount -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium leading-tight">Min purchase amount:</label>
                            <input type="number" id="minPurchase" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="minPurchaseError" class="error-msg md:ml-40"></span>
                    </div>

                    <!-- Start Date -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium">Start Date :</label>
                            <input type="date" id="startDate" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="startDateError" class="error-msg md:ml-40"></span>
                    </div>

                    <!-- End Date -->
                    <div class="flex flex-col gap-1">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <label class="w-full md:w-40 text-sm font-medium">End Date :</label>
                            <input type="date" id="endDate" class="flex-1 bg-gray-200 border-none rounded-md px-4 py-2.5 focus:ring-2 focus:ring-indigo-400 outline-none">
                        </div>
                        <span id="endDateError" class="error-msg md:ml-40"></span>
                    </div>
                </div>

                <div class="mt-16 flex justify-center">
                    <button type="submit" id="submitBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-12 rounded-xl shadow-md transition-all flex items-center gap-2">
                        <span>Add coupon</span>
                    </button>
                </div>
            </form>
        </main>
    </div>

    <script>
        document.getElementById('couponForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const errorSpans = document.querySelectorAll('.error-msg');
            const inputs = document.querySelectorAll('input');
            const generalError = document.getElementById('formGeneralError');
            
            errorSpans.forEach(span => span.textContent = '');
            inputs.forEach(input => input.classList.remove('error-border'));
            generalError.textContent = '';

            let isValid = true;

            // 1. Coupon Code
            const couponCode = document.getElementById('couponCode').value.trim();
            const codePattern = /^[A-Z0-9]+$/i; 
            if (couponCode.length < 5) {
                showError('couponCode', 'At least 5 characters required');
                isValid = false;
            } else if (!codePattern.test(couponCode)) {
                showError('couponCode', 'Only letters and numbers allowed');
                isValid = false;
            }

            // 2. Discount
            const discount = parseFloat(document.getElementById('discount').value);
            if (isNaN(discount) || discount < 1 || discount > 100) {
                showError('discount', 'Discount must be between 1 and 100');
                isValid = false;
            }

            // 3. UPTO (New Validation)
            const upto = parseFloat(document.getElementById('upto').value);
            const minPurchase = parseFloat(document.getElementById('minPurchase').value);

            if (isNaN(upto) || upto <= 0) {
                showError('upto', 'Value must be required');
                isValid = false;
            } 

            // 4. Usage Limits
            const totalLimit = parseInt(document.getElementById('totalLimit').value);
            if (isNaN(totalLimit) || totalLimit < 0) {
                showError('totalLimit', 'Limit must be 0 or greater');
                isValid = false;
            }

            const perUserLimit = parseInt(document.getElementById('perUserLimit').value);
            if (isNaN(perUserLimit) || perUserLimit < 0) {
                showError('perUserLimit', 'Limit must be 0 or greater');
                isValid = false;
            }

            // 5. Min Purchase
            if (isNaN(minPurchase) || minPurchase < 0) {
                showError('minPurchase', 'Amount cannot be negative');
                isValid = false;
            }

            // 6. Dates
            const startDateVal = document.getElementById('startDate').value;
            const endDateVal = document.getElementById('endDate').value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!startDateVal) {
                showError('startDate', 'Start date is required');
                isValid = false;
            } else {
                const startDate = new Date(startDateVal);
                if (startDate < today) {
                    showError('startDate', 'Cannot select a past date');
                    isValid = false;
                }
            }

            if (!endDateVal) {
                showError('endDate', 'End date is required');
                isValid = false;
            } else {
                const startDate = new Date(startDateVal);
                const endDate = new Date(endDateVal);
                if (endDate <= startDate) {
                    showError('endDate', 'End date must be after start date');
                    isValid = false;
                }
            }

            if (isValid) {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;

                const formData = {
                    couponCode,
                    discount,
                    totalLimit,
                    perUserLimit,
                    minPurchase,
                    upto,
                    startDate: startDateVal,
                    endDate: endDateVal
                };

                try {
                    const response = await fetch('/admin/addCoupon', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        window.location.href = '/admin/coupon';
                    } else {
                        generalError.textContent = result.message || 'Failed to add coupon.';
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    generalError.textContent = 'Network error. Please try again.';
                    submitBtn.disabled = false;
                }
            }
        });

        function showError(inputId, message) {
            const errorSpan = document.getElementById(inputId + 'Error');
            const inputField = document.getElementById(inputId);
            if (errorSpan) errorSpan.textContent = message;
            if (inputField) inputField.classList.add('error-border');
        }
    </script>
</body>
</html>