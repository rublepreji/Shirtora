<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Category Management | Shirtora Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* smooth transition for sidebar */
      .sidebar {
        transition: all 0.3s ease-in-out;
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen flex font-inter overflow-hidden">
    <!-- Sidebar -->
    <aside
      class="sidebar w-64 bg-white border-r border-gray-200 hidden md:flex flex-col fixed inset-y-0 left-0 z-30"
    >
      <%- include("../../view/partials/admin/sideBar") %>
    </aside>

    <!-- Main Content -->
    <main
      class="flex-1 md:ml-64 p-6 md:p-10 transition-all duration-300 overflow-x-auto"
    >
      <!-- Header -->
<div class="flex justify-between items-center mb-8">
  <h1 class="text-xl md:text-2xl font-semibold text-gray-800">Category</h1>
  <a href="/admin/addcategory">
    <button
      class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md transition"
    >
      + Add Category
    </button>
  </a>
</div>

<!-- Search Bar Section -->
<div class="flex justify-center mb-6">
  <div class="relative w-full sm:w-1/2 md:w-1/3">
    <span
      class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
    >
      <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </span>
    <input
      type="text"
      id="searchCategory"
      placeholder=" Search category..."
      class="w-full border border-gray-300 rounded-full pl-10 pr-8 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition"
    />
    <button
      id="clearSearch"
      class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"
    >
      âœ•
    </button>
  </div>
</div>


      <!-- Table Section -->
      <div
        class="overflow-x-auto rounded-lg shadow-md border border-gray-200 bg-white mt-8"
      >
        <table class="w-full text-sm text-left">
          <thead class="bg-indigo-500 text-white">
            <tr>
              <th class="px-4 py-3 w-16">S.No</th>
              <th class="px-4 py-3">Category Name</th>
              <th class="px-4 py-3">Description</th>
              <th class="px-4 py-3 text-center">Update</th>
            </tr>
          </thead>
          <tbody class="text-gray-700">
           
          </tbody>
        </table>
      </div>

     
      <div id="pagination" class="flex justify-center items-center mt-6 space-x-2 text-sm">
    
      </div>
    </main>
  </body>
</html>

<script>
  const searchInput = document.getElementById("searchCategory");
  const clearBtn = document.getElementById("clearSearch");
  const categoryTable = document.querySelector("tbody");
  const pagination = document.getElementById("pagination");

  let totalPage = 1;
  let currentPage = 1;
  let searchTerm = "";
  let searchTimer;

  // Fetch and Render Data
  async function fetchData(search = "", page = 1) {
    try {
      const response = await fetch(`/admin/dataForCategory?search=${search}&page=${page}`);
      const data = await response.json();

      if (data.success) {
        renderTable(data.data);
        totalPage = data.totalPages;
        currentPage = data.currentPage;
        renderPagination(); // render pagination every time
      }
    } catch (err) {
      console.error("Error fetching data:", err);
    }
  }

  // Render Table
  function renderTable(category) {
    categoryTable.innerHTML = category
      .map(
        (cat, i) => `
      <tr class="border-t">
        <td class="px-4 py-3 font-medium">${i + 1}</td>
        <td class="px-4 py-3">${cat.name}</td>
        <td class="px-4 py-3">${cat.description}</td>
        <td class="py-3 px-4 text-center">
          <div class="flex justify-center items-center gap-2">
            <button 
              class="delete-btn text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-md hover:bg-orange-200 transition"
              data-id="${cat._id}">
              Delete
            </button>
            <a href="/admin/editCategory/${cat._id}">
              <button 
                class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-md hover:bg-blue-200 transition">
                Edit
              </button>
            </a>
          </div>
        </td>
      </tr>`
      )
      .join("");
    attachDeleteEvents(); 
  }

  // Render Pagination
  function renderPagination() {
    let pageButtons = "";

    for (let i = 1; i <= totalPage; i++) {
      pageButtons += `
        <button 
          class="px-3 py-1 rounded-md ${
            i === currentPage
              ? "bg-blue-600 text-white"
              : "bg-gray-200 text-gray-700 hover:bg-gray-300"
          }" 
          data-page="${i}">
          ${i}
        </button>`;
    }

    pagination.innerHTML = `
      <button id="prevBtn" ${
        currentPage === 1 ? "disabled" : ""
      } class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
        Previous
      </button>
      ${pageButtons}
      <button id="nextBtn" ${
        currentPage === totalPage ? "disabled" : ""
      } class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
        Next
      </button>
    `;

    // Now safely attach event listeners
    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentPage > 1) fetchData(searchTerm, currentPage - 1);
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (currentPage < totalPage) fetchData(searchTerm, currentPage + 1);
    });

    document.querySelectorAll("[data-page]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const page = Number(btn.getAttribute("data-page"));
        fetchData(searchTerm, page);
      });
    });
  }

  // Search Input with Debounce
  searchInput.addEventListener("input", () => {
    searchTerm = searchInput.value.trim();

    if (searchTerm) {
      clearBtn.classList.remove("hidden");
    } else {
      clearBtn.classList.add("hidden");
    }

    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      fetchData(searchTerm, 1);
    }, 500);
  });

  // Clear Search
  clearBtn.addEventListener("click", () => {
    searchInput.value = "";
    clearBtn.classList.add("hidden");
    searchTerm = "";
    fetchData("", 1);
  });

  //Delete Button Logic
  function attachDeleteEvents() {
    const buttons = document.querySelectorAll(".delete-btn");

    buttons.forEach((button) => {
      button.addEventListener("click", async (e) => {
        const id = e.currentTarget.dataset.id;

        const confirm = await Swal.fire({
          title: "Are you sure?",
          text: "This category will be hidden, not permanently deleted.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!",
        });

        if (confirm.isConfirmed) {
          try {
            const response = await fetch(`/admin/deleteCategory/${id}`, {
              method: "POST",
            });
            const data = await response.json();

            if (response.ok) {
              Swal.fire("Deleted!", data.message, "success").then(() => {
                fetchData(searchTerm, currentPage);
              });
            } else {
              Swal.fire("Error", data.message, "error");
            }
          } catch (err) {
            console.error("Error deleting:", err);
            Swal.fire("Error!", "Something went wrong!", "error");
          }
        }
      });
    });
  }

  //Initial load
  fetchData();
</script>
