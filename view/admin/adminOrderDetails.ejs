<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%-include("../../view/partials/admin/sideBar")%>
    <!-- MAIN CONTENT (shifted right for sidebar) -->
<div class="ml-64 p-6 md:p-10">

    <!-- Page Title -->
    <h2 class="text-2xl font-semibold mb-6">Order Details</h2>

    <!-- Order ID + Status -->
    <div class="flex items-center gap-3 mb-4">
        <p class="text-xl font-semibold">Orders ID: <%=order.orderId%></p>

        <span class="px-3 py-1 rounded-md bg-red-100 text-red-600 text-sm font-medium">
            <%=order.status%>
        </span>
    </div>

    <!-- Date Range -->
    <div class="flex items-center text-gray-700 gap-2 mb-8">
        <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 
                     0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <p class="text-gray-800">
            <%=new Date(order.createdAt).toDateString()%>
        </p>
    </div>

    <!-- Details Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6 text-gray-700 text-sm">

        <!-- Left Column -->
        <div>
            <p class="font-medium">Coupon :</p>
            <input 
                type="text"
                value="AB-CD-123"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        <div>
            <p class="font-medium">Payment Method :</p>
            <input 
                type="text"
                value="<%=order.paymentMethod%>"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        <div>
            <p class="font-medium">Customer Name :</p>
            <input 
                type="text"
                value="<%=order.address.firstName%>  <%=order.address.lastName%>"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        <div>
            <p class="font-medium">Mobile Number :</p>
            <input 
                type="text"
                value="<%=order.address.phone%>"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        <div>
            <p class="font-medium">Shipping Address :</p>
            <input 
                type="text"
                value="<%=order.address.addressLine%>"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        <div>
            <p class="font-medium">Delivery Date :</p>
            <input 
                type="text"
                value="21-09-2024"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        
            
<% order.items.forEach((item, i) => { %>

<div class="w-full mt-3">
    <div class="flex justify-between">
    <p class="font-medium">Product : <%= item.productId.productName %> </p>
    <p class="font-medium">Size : <%= item.productId.variants[item.variantIndex].size %> </p>
    <p class="font-medium">Quantity : <%= item.quantity %> </p>
    </div>
    <div class="relative mt-1">

        <!-- Dropdown -->
        <select 
            id="productStatus-<%= i %>"
            class="w-full px-4 py-2 pr-20 border rounded-md bg-white text-gray-800"
        >
            <% ["Ordered","Cancelled","Returned","Delivered","Return-Approved","Return-Rejected","Return Requested"].forEach(status => { %>
                <option value="<%= status %>" 
                    <%= item.itemStatus === status ? 'selected' : '' %>>
                    <%= status %>
                </option>
            <% }) %>
        </select>

        <!-- Save Button -->
        <button
            onclick="saveProductStatus('<%= order._id %>', '<%= i %>')"
            class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 
                   text-white text-xs px-3 py-1 rounded hover:bg-blue-600">
            Save
        </button>

    </div>

</div>



<% if (item.itemStatus === "Return Requested") { %>

<div class="mt-3 border border-yellow-300 bg-yellow-50 rounded-md p-4">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- LEFT COLUMN : PRODUCT NAME -->
        <div>
            <p class="text-sm font-semibold text-gray-800 mb-1">Product</p>
            <p class="text-sm bg-white border rounded p-2 font-medium">
                <%= item.productId.productName %>
            </p>
        </div>

        <!-- RIGHT COLUMN : REASON + BUTTONS -->
        <div>
            <p class="text-sm font-semibold text-yellow-700 mb-1">Return Reason</p>

            <p class="text-xs bg-white border rounded p-2 mb-3 text-gray-800">
                <%= item.returnReason || "No reason provided" %>
            </p>

            <div class="flex gap-3">
                <button 
                    onclick="approveReturn('<%= order._id %>', '<%= i %>')"
                    class="px-4 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                    Approve
                </button>

                <button 
                    onclick="rejectReturn('<%= order._id %>', '<%= i %>')"
                    class="px-4 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                    Reject
                </button>
            </div>
        </div>

    </div>

</div>

<% } %>


<% }) %>

        

    

    

        <div class="md:col-span-2">
            <p class="font-medium">Total Amount :</p>
            <input 
                type="text"
                value="<%=order.totalAmount%>/-"
                class="w-full mt-1 px-4 py-2 border rounded-md bg-gray-100"
                readonly
            />
        </div>

        <div class="md:col-span-2">
            <p class="font-medium">Change Status :</p>

            <% const statusOptions = ['Pending','Processing','Shipped','Delivered','Cancelled','Return Requested','Returned']; %>

            <select
                name="status"
                class="w-full mt-1 px-4 py-2 border rounded-md border-gray-400 bg-white text-gray-700"
            >
                <% statusOptions.forEach((status) => { %>
                    <option value="<%= status %>" 
                        <%= order.status === status ? "selected" : "" %>>
                        <%= status %>
                    </option>
                <% }) %>
            </select>
        </div>

    </div>

    <!-- Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center mt-10">

        <button class="px-8 py-3 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700">
            Cancel Order
        </button>

        <button class="px-8 py-3 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 update-status-btn">
            Update Status
        </button>

    </div>

</div>
<script>
document.querySelector(".update-status-btn").addEventListener("click", async () => {
    const selectedStatus = document.querySelector("select[name='status']").value;
    const orderId = "<%= order.orderId %>";

    const res = await fetch("/admin/updateOrderStatus", {
        method: "put",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId, newStatus: selectedStatus })
    });

    const data = await res.json();

    if (data.success) {
        Swal.fire("Updated!", "Order status changed successfully", "success");
    } else {
        Swal.fire("Error", "Failed to update", "error");
    }
});


async function saveProductStatus(orderId, itemIndex) {
    const newStatus = document.getElementById(`productStatus-${itemIndex}`).value;

    const res = await fetch("/admin/updateItemStatus", {
        method: "PUT",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ orderId, itemIndex, newStatus })
    });

    const data = await res.json();

    if (data.success) {
        Swal.fire("Success", "Product status updated!", "success");
    } else {
        Swal.fire("Error", "Failed to update status", "error");
    }
}


async function approveReturn(orderId, itemIndex) {
    await updateReturnStatus(orderId, itemIndex, "Return-Approved");
}

async function rejectReturn(orderId, itemIndex) {
    await updateReturnStatus(orderId, itemIndex, "Return-Rejected");
}

async function updateReturnStatus(orderId, itemIndex, newStatus) {
    const res = await fetch("/admin/updateReturnStatus", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId, itemIndex, newStatus })
    });

    const data = await res.json();

    if (data.success) {

        document.getElementById(`productStatus-${itemIndex}`).value = newStatus;
        window.location.reload()
    } else {
        Swal.fire("Error", data.message || "Failed to update", "error");
    }
}


</script>

</body>
</html>