<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%-include("../../view/partials/admin/sideBar")%>
<div class="ml-64 p-6 md:p-10">

    <h2 class="text-2xl font-semibold mb-6">
        Order Details – <span class="font-bold"><%=order.orderId%></span>
    </h2>


    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div class="border rounded-lg p-5 bg-white shadow-sm">

            <h3 class="text-lg font-semibold mb-3">Order Information</h3>

            <div class="text-sm space-y-2 text-gray-700">

                <p><span class="font-medium">Customer:</span> 
                    <%=order.address.firstName%> <%=order.address.lastName%>
                </p>

                <p><span class="font-medium">Payment Method:</span> 
                    <%=order.paymentMethod%>
                </p>

                <p><span class="font-medium">Payment Status:</span> 
                    <span class="font-semibold text-red-600"><%=order.paymentStatus%></span>
                </p>

                <p><span class="font-medium">Order Status:</span> 
                    <span class="font-semibold"><%=order.status%></span>
                </p>

                <p><span class="font-medium">Order Date:</span> 
                    <%=new Date(order.createdAt).toLocaleString() %>
                </p>

                <p><span class="font-medium">Total Amount:</span> 
                    ₹<%=order.offerAmount%>
                </p>

            </div>

        </div>


        <!-- DELIVERY ADDRESS CARD -->
        <div class="border rounded-lg p-5 bg-white shadow-sm">

            <h3 class="text-lg font-semibold mb-3">Delivery Address</h3>

            <div class="text-sm text-gray-700 space-y-1">
                <p><%=order.address.addressLine%></p>
                <p><%=order.address.city%>, <%=order.address.state%></p>
                <p><%=order.address.pincode%></p>
                <p><%=order.address.phone%></p>
            </div>

        </div>

    </div>


      <!-- ORDER STATUS UPDATE -->
    <!-- <div class="mt-10">

        <p class="font-medium mb-2">Change Status :</p>

        <select
            name="status"
            class="w-full md:w-1/3 px-4 py-2 border rounded-md"
        >
            <% ['Pending','Processing','Shipped','Delivered','Cancelled','Return Requested','Returned'].forEach((status) => { %>
                <option value="<%= status %>" 
                    <%= order.status === status ? "selected" : "" %>>
                    <%= status %>
                </option>
            <% }) %>
        </select>

    </div> -->
        <%if(order.paymentStatus!=="Failed"){%>
         <div class="flex gap-4 mt-6 justify-end">

            <button onclick="cancelOrder('<%= order.orderId %>')"    class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Cancel Order
            </button>

            <!-- <button class="px-8 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 update-status-btn">
                Update Status
            </button> -->

        </div>
        <%}%>

    <!-- ITEMS TABLE -->
    <div class="mt-10 border rounded-lg bg-white shadow-sm">

        <h3 class="text-lg font-semibold p-4 border-b">Items in Order</h3>

        <div class="overflow-x-auto">

            <table class="w-full text-sm text-gray-700">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left">Product</th>
                        <th class="p-3 text-center">Qty</th>
                        <th class="p-3 text-right">Unit Price</th>
                        <th class="p-3 text-right">Total</th>   
                        <th class="p-3 text-center">Status</th>
                        <th class="p-3 text-center">Actions</th>
                    </tr>
                </thead>

                <tbody>

                <% order.items.forEach((item, i) => { %>

                    <tr class="border-b">

                        <td class="p-3">
                            <%= item.productId.productName %> — 
                            (<%= item.productId.variants[item.variantIndex].size %>)
                        </td>

                        <td class="p-3 text-center"><%= item.quantity %></td>

                        <td class="p-3 text-right">₹<%= item.pricePerUnit %></td>

                        <td class="p-3 text-right">
                            ₹<%= item.quantity * item.totalPrice %>
                        </td>

                        <td class="p-3 text-center font-medium">
                            <%= item.itemStatus %>
                        </td>

                        <td class="p-3 text-center">

                            <div class="flex items-center gap-2 justify-center">
                                <%if(item.itemStatus!=="Cancelled"){%>
                                <select 
                                    id="productStatus-<%= i %>"
                                    class="border rounded px-2 py-1"
                                >
                                    <% ["Ordered","Shipped","Processing","Tracking","Delivered"].forEach(status => { %>
                                        <option value="<%= status %>"
                                            <%= item.itemStatus === status ? 'selected' : '' %>>
                                            <%= status %>
                                        </option>
                                    <% }) %>
                                </select>
                               

                                <button
                                    onclick="saveProductStatus('<%= order._id %>', '<%= i %>')"
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                    Update
                                </button>
                                 <%}else{%>
                                    <span class="font-bold text-red-600">Cancelled</span>
                                    <%}%>
                            </div>

                        </td>

                    </tr>


                    <% if (item.itemStatus === "Return Requested") { %>

                        <tr class="bg-yellow-50">
                            <td colspan="6" class="p-4">

                                <div class="flex flex-col md:flex-row justify-between items-start gap-4">

                                    <div>
                                        <p class="font-semibold text-sm">Return Reason</p>
                                        <p class="text-xs mt-1">
                                            <%= item.returnReason || "No reason provided" %>
                                        </p>
                                    </div>

                                    <div class="flex gap-3">
                                        <button 
                                            onclick="approveReturn('<%= order._id %>', '<%= i %>')"
                                            class="px-4 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                            Approve
                                        </button>

                                        <button 
                                            onclick="rejectReturn('<%= order._id %>', '<%= i %>')"
                                            class="px-4 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                            Reject
                                        </button>
                                    </div>

                                </div>

                            </td>
                        </tr>

                    <% } %>

                <% }) %>

                </tbody>

            </table>

        </div>

    </div>



  

</div>


<script>
    document.querySelector(".update-status-btn").addEventListener("click", async () => {
    const selectedStatus = document.querySelector("select[name='status']").value;
    const orderId = "<%= order.orderId %>";

    const res = await fetch("/admin/updateOrderStatus", {
        method: "put",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId, newStatus: selectedStatus })
    });

    const data = await res.json();

    if (data.success) {
        Swal.fire("Updated!", data.message || "Order status changed successfully", "success");
    } else {
        Swal.fire("Error", data.message || "Failed to update", "error");
    }
});
</script>
<script src="/js/admin/adminOrderDetails.js"></script>
</body>
</html>