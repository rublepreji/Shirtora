  <!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Users | Admin Panel</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    </head>

    <body class="bg-gray-50 min-h-screen flex">

      <!-- Sidebar -->
      <%- include("../../view/partials/admin/sideBar") %>

      <!-- Main Section -->
      <main class="lg:ml-64 ml-0 flex-1 px-6 py-10">
        
        <!-- Header -->
        <div class="flex flex-row items-start justify-start mb-8">

          <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">User Management</h1>
        </div>

        <!-- Filter Section -->
        <div class="flex justify-around mr-3 mb-6">
          <div></div>
            <!-- Centered Search Bar -->
         <div class="relative w-64">
          <input
            type="text"
            placeholder="Search"
            id="search"
            class="w-full border border-gray-300 rounded-full px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button
            id="clearSearch"
            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"
          >
            âœ•
          </button>
          </div>
          <div class="flex items-center border rounded-xl px-4 py-2 bg-white shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2l-7 9v5l-4-2v-3L3 6V4z" />
            </svg>
            <label for="filter" class="mr-2 text-gray-700 text-sm font-medium">Filter By</label>

            <select id="filter" class="border-none text-gray-700 focus:outline-none">
              <option value="blocked" >Blocked</option>
              <option value="active">Active</option>
              <option value="all">All</option>
            </select>

          </div>
        </div>

        <!-- User Table -->
        <div class="overflow-x-auto bg-white rounded-2xl shadow-sm">
          <table class="w-full text-left text-gray-700">
            <thead>
              <tr class="bg-indigo-500 text-white text-sm">
                <th class="py-3 px-4 rounded-tl-2xl">S.No</th>
                <th class="py-3 px-4">Name</th>
                <th class="py-3 px-4">Email</th>
                <th class="py-3 px-4">Mobile</th>
                <th class="py-3 px-4 rounded-tr-2xl">Update</th>
              </tr>
            </thead>

            <tbody class="text-sm">
             
            </tbody>
          </table>
        </div>

        <!-- Pagination Section -->
  <div class="flex justify-center mt-6">
    <nav id="pagination" class="inline-flex items-center space-x-2">

     
    </nav>
  </div>
  </main>

   <script>
    const table= document.querySelector('tbody')
    const pagination= document.getElementById('pagination')
    const searchInput= document.getElementById('search')
    const clearBtn= document.getElementById('clearSearch')

    let totalPage=1
    let currentPage=1
    let searchTerm=''
    let filter='all'

  async function fetchData(search="",page=1,filter="all") {
  const response = await fetch(`/admin/dataForUserPage?search=${search}&page=${page}&filter=${filter}`);
  console.log('page',page);
  
  const data = await response.json();
    console.log(data);
    
  if(data.success){
    renderTable(data.data);
    totalPage=Number(data.totalPages);
    currentPage=Number(data.currentPage);
    renderPagination()
  }
}

//search
let searchTimer;
searchInput.addEventListener('input',()=>{
  searchTerm=searchInput.value.trim()
  if(searchInput.value.trim()!==""){
    clearBtn.classList.remove('hidden')
  }else{
    clearBtn.classList.add('hidden')
  }

  clearTimeout(searchTimer)
  searchTimer=setTimeout(()=>{
    currentPage=1
    fetchData(searchTerm,currentPage,filter)
  },400)
})

function renderTable(users) {
  table.innerHTML = users.map((val, i) => `
    <tr class="border-b hover:bg-gray-50">
      <td class="py-3 px-4">${i + 1}</td>
      <td class="py-3 px-4">${val.fullName}</td>
      <td class="py-3 px-4">${val.email}</td>
      <td class="py-3 px-4">${val.phone || ""}</td>
      <td class="py-3 px-4">
        ${!val.isBlocked
          ? `<button class="block-btn text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-md"
                  data-id="${val._id}" data-action="blockuser">Block</button>`
          : `<button class="unblock-btn text-xs bg-green-100 text-green-600 px-2 py-1 rounded-md"
                  data-id="${val._id}" data-action="unblockuser">Unblock</button>`
        }
      </td>
    </tr>
  `).join("");
}

// Event Delegation for block/unblock
table.addEventListener("click", async (e) => {
  if (!e.target.matches(".block-btn, .unblock-btn")) return;

  const userId = e.target.dataset.id;
  const action = e.target.dataset.action;

  const isBlock = action === "blockuser";

  const result = await Swal.fire({
    title: isBlock ? "Block this user" : "Unblock this user",
    text: "Are you sure?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: isBlock ? "#d33" : "#3085d6",
    cancelButtonColor: "#aaa",
    confirmButtonText: isBlock ? "Yes, block" : "Yes, unblock",
  });

  if (!result.isConfirmed) return;

  const response = await fetch(`/admin/${action}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: userId })
  });

  const data = await response.json();

  if (data.success) {
    fetchData(searchTerm, currentPage, filter);
  }
});

function renderPagination() {
  let paginationButton=''

  for(let i=1;i<=totalPage;i++){
    paginationButton+=`
      <button data-page="${i}" class="px-3 py-1 border rounded-md ${ i == currentPage ? 'bg-indigo-500 text-white' : 'text-gray-600 hover:bg-gray-100' }" >
      ${i}
    </button>
    `
  }
  pagination.innerHTML=`
    <button id="prevBtn" ${currentPage==1 ?"disabled":""} class="px-3 py-1 border rounded-md text-gray-600 hover:bg-gray-100">
      Previous
    </button>

    ${paginationButton}

    <button id="nextBtn" ${currentPage==totalPage ?"disabled":""} class="px-3 py-1 border rounded-md text-gray-600 hover:bg-gray-100">
      Next
    </button>
  `


  document.getElementById('prevBtn').addEventListener('click',()=>{
    if(currentPage>1){
      fetchData(searchTerm,currentPage-1,filter)
    }
  })
  document.getElementById('nextBtn').addEventListener('click',()=>{
    if(currentPage<totalPage){
      fetchData(searchTerm,currentPage+1,filter)
    }
  })
  document.querySelectorAll("[data-page]").forEach((btn)=>{
    btn.addEventListener('click',()=>{
      currentPage=parseInt(btn.getAttribute('data-page'))
      fetchData(searchTerm,currentPage,filter)
    })
  })

}

document.getElementById('filter').addEventListener('change', function () {
  filter = this.value;
  currentPage=1
  fetchData(searchTerm,currentPage,filter)
});


clearBtn.addEventListener('click',()=>{
  searchInput.value=""
  clearBtn.classList.add('hidden')
  fetchData("",currentPage,filter)
})
fetchData();

  </script>
