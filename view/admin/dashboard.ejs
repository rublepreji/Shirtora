<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Shirtora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">

    <%-include("../../view/partials/admin/sideBar") %>

    <div class="pl-64 flex flex-col min-h-screen">
        
        <%-include("../../view/partials/admin/header") %>

        <main class="p-8">
            
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
                    <p class="text-gray-500 mt-1">Welcome back, Admin</p>
                </div>

                <div class="relative w-56 group">
                    <label for="range" class="sr-only">Select Range</label>
                    <select id="range" class="w-full appearance-none bg-white border border-gray-200 text-gray-700 py-3 px-4 pr-10 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all cursor-pointer font-medium hover:bg-gray-50">
                        <option value="yearly">Yearly Overview</option>
                        <option value="monthly" selected>Monthly Overview</option>
                        <option value="weekly">Weekly Overview</option>
                    </select>
                    
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Total User</p>
                        <h3 id="totalUsers" class="text-2xl font-bold text-gray-900 mt-1"></h3>
                        <!-- <p class="text-green-500 text-xs mt-2 font-semibold">↑ 8.5% <span class="text-gray-400 font-normal">from last month</span></p> -->
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-xl text-indigo-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Total Order</p>
                        <h3 id="totalOrders" class="text-2xl font-bold text-gray-900 mt-1"></h3>
                        <!-- <p class="text-green-500 text-xs mt-2 font-semibold">↑ 1.3% <span class="text-gray-400 font-normal">from last month</span></p> -->
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-xl text-yellow-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 uppercase">Total Sales</p>
                        <h3 id="totalSales" class="text-2xl font-bold text-gray-900 mt-1"></h3>
                        <!-- <p class="text-red-500 text-xs mt-2 font-semibold">↓ 4.3% <span class="text-gray-400 font-normal">from last month</span></p> -->
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl text-green-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <!-- Indian Rupee (₹) Path -->
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 3h12M6 8h12M14.5 3.1c0 7.9-11 7.9-11 7.9M9 11l6.7 9.7"></path>
                </svg>
            </div>
                </div>
            </div>

            <div class="bg-white shadow-sm border border-gray-100 p-6 rounded-2xl mb-8">
                <h3 class="font-bold text-gray-800 mb-6">Revenue Analysis</h3>
                <div class="h-72 flex items-center justify-center bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 italic">
                    <canvas id="salesChart"></canvas> 
                </div>
            </div>

            <!-- TOP CHARTS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

            <!-- TOP PRODUCTS -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-800 mb-4">Top Products</h3>
                <canvas id="productChart"></canvas>
            </div>

            <!-- TOP CATEGORIES -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-800 mb-4">Top Categories</h3>
                <canvas id="categoryChart"></canvas>
            </div>

            <!-- TOP BRANDS -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-800 mb-4">Top Brands</h3>
                <canvas id="brandChart"></canvas>
            </div>

            </div>
        </main>
    </div>
</body>

<script>
let chart

async function loadChart(){

  const range = document.getElementById("range").value
  const res = await fetch(`/admin/dashboard?range=${range}`)
  const data = await res.json()

  if(!data.success) return

  let labels = []
  let values = []

  const chartMap = {}

  // DB result to map
  data.chartData.forEach(i=>{
    if(range==="yearly") chartMap[i._id.month] = i.totalOrders
    if(range==="monthly") chartMap[i._id.week] = i.totalOrders
    if(range==="weekly") chartMap[i._id.day] = i.totalOrders
  })

  const now = new Date()

  // Year
  if(range==="yearly"){

    const months = ["Jan","Feb","Mar","Apr","May","Jun",
                    "Jul","Aug","Sep","Oct","Nov","Dec"]

    for(let m=1; m<=12; m++){
      labels.push(months[m-1])
      values.push(chartMap[m] || 0)
    }
  }

  // month
  if(range==="monthly"){

    const totalWeeks = 5  

    for(let w=1; w<=totalWeeks; w++){
      labels.push("Week " + w)
      values.push(chartMap[w] || 0)
    }
  }

  // weekly
  if(range==="weekly"){

    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]

    for(let d=1; d<=7; d++){
      labels.push(days[d-1])
      values.push(chartMap[d] || 0)
    }
  }

  // chart
  if(chart) chart.destroy()

  chart = new Chart(document.getElementById("salesChart"),{
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:"Orders",
        data:values
      }]
    },
    options:{ responsive:true }
  })

  // dashboard card
  document.getElementById("totalOrders").innerHTML =
    data.summary.totalOrders.toLocaleString()

  document.getElementById("totalSales").innerHTML =
    "₹" + data.summary.totalSales.toLocaleString()

  document.getElementById("totalUsers").innerHTML =
    data.totalUsers.toLocaleString()

    drawTopCharts(data)
}

document.getElementById("range")
  .addEventListener("change",loadChart)

loadChart()

let productChart, categoryChart, brandChart

function drawTopCharts(data){

  // products
  const pLabels = data.topProducts.map(p=>p.product.productName)
  const pValues = data.topProducts.map(p=>p.totalQty)

  if(productChart) productChart.destroy()

  productChart = new Chart(
    document.getElementById("productChart"),{
      type:"doughnut",
      data:{
        labels:pLabels,
        datasets:[{
          label:"Quantity",
          data:pValues
        }]
      }
  })

  // category
  const cLabels = data.topCategories.map(c=>c.name)
  const cValues = data.topCategories.map(c=>c.totalQty)

  if(categoryChart) categoryChart.destroy()

  categoryChart = new Chart(
    document.getElementById("categoryChart"),{
      type:"line",
      data:{
        labels:cLabels,
        datasets:[{
          label:"Quantity",
          data:cValues
        }]
      }
  })

  // brand
  const bLabels = data.topBrands.map(b=>b.name)
  const bValues = data.topBrands.map(b=>b.totalQty)

  if(brandChart) brandChart.destroy()

  brandChart = new Chart(
    document.getElementById("brandChart"),{
      type:"doughnut",
      data:{
        labels:bLabels,
        datasets:[{
          label:"Quantity",
          data:bValues
        }]
      }
  })
}

</script>


</html>