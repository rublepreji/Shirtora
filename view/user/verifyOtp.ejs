<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enter the OTP | Shirtora</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #fff;
      min-height: 100vh;
    }
    .input-line {
      border: none;
      border-bottom: 1px solid #000;
      outline: none;
      background-color: transparent;
      width: 100%;
      padding-bottom: 0.4rem;
    }
    #resend-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <div class="w-full max-w-md mx-auto">
    <h1 class="text-2xl sm:text-3xl font-semibold text-black mb-2">Enter the OTP</h1>
    <p class="text-sm text-gray-600 mb-8">The OTP has sent to your registered email</p>

    <form onsubmit="return validateOTPForm()" class="space-y-8">
      <!-- OTP Input Row -->
      <div class="flex items-end space-x-3">
        <div class="flex-1 relative">
          <input
            type="text"
            id="otp"
            name="otp"
            maxlength="6"
            placeholder="Enter your otp"
            class="input-line text-base"
          />
          <p id="timerValue" class="text-xs text-red-500 mt-1 absolute -bottom-5 left-0"></p>
        </div>
        <button
          type="button"
          id="resend-button"
          disabled
          class="px-4 py-1.5 text-sm bg-black text-white rounded-sm hover:bg-gray-900 transition"
        >
          Resend OTP
        </button>
      </div>

      <!-- Bottom Row -->
      <div class="flex justify-between items-center">
        <a href="/signin" class="text-sm text-gray-600 hover:text-black transition">
          ‚Üê Back to Login
        </a>
        <button
          type="submit"
          class="px-8 py-2 bg-black text-white text-sm font-medium rounded-sm hover:bg-gray-900 transition"
        >
          Verify
        </button>
      </div>
    </form>
  </div>

  <script>
    const otpInput = document.getElementById("otp");
    const timerDisplay = document.getElementById("timerValue");
    const resendButton = document.getElementById("resend-button");

    let timer = 60;
    let timerInterval;

    const storedTime = localStorage.getItem("otpExpireTime");
    const now = Date.now();

    if (storedTime && now < parseInt(storedTime)) {
      timer = Math.floor((parseInt(storedTime) - now) / 1000);
    } else {
      localStorage.setItem("otpExpireTime", Date.now() + 60000);
    }

    otpInput.focus();

    // üïí Start timer
    function startTimer() {
      resendButton.disabled = true;
      updateTimerDisplay();

      timerInterval = setInterval(() => {
        timer--;
        updateTimerDisplay();

        if (timer <= 0) {
          clearInterval(timerInterval);
          timerDisplay.textContent = "Expired";
          resendButton.disabled = false;
          localStorage.removeItem("otpExpireTime");
          Swal.fire({
            icon: "info",
            title: "OTP Expired",
            text: "You can now resend a new OTP.",
            confirmButtonColor: "#000",
          });
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      if (timer > 0) {
        const min = Math.floor(timer / 60);
        const sec = timer % 60;
        timerDisplay.textContent = `${min}:${sec < 10 ? "0" + sec : sec}`;
      }
    }

    startTimer();

    // üì® Verify OTP
    function validateOTPForm() {
      const otpVal = otpInput.value.trim();

      if (!otpVal) {
        Swal.fire({
          icon: "warning",
          title: "Please enter your OTP",
        });
        return false;
      }

      $.ajax({
        type: "POST",
        url: "/verifyOtp",
        contentType: "application/json",
        data: JSON.stringify({ otp: otpVal }),
        success: function (response) {
          if (response.success) {
            Swal.fire({
              title: "OTP Verified Successfully",
              icon: "success",
              timer: 1500,
              showConfirmButton: false,
            }).then(() => {
              localStorage.removeItem("otpExpireTime");
              window.location.href = response.redirectUrl;
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: response.message,
            });
          }
        },
        error: function () {
          Swal.fire({
            icon: "error",
            title: "Please try again",
            text: "An error occurred during verification.",
          });
        },
      });

      return false;
    }

    // üîÅ Resend OTP
    resendButton.addEventListener("click", () => {
      resendButton.disabled = true;
      timer = 60;
      localStorage.setItem("otpExpireTime", Date.now() + 60000);
      startTimer();

      $.ajax({
        type: "POST",
        url: "/resendOtp",
        success: function () {
          Swal.fire({
            icon: "info",
            title: "OTP Resent Successfully",
            timer: 1500,
            showConfirmButton: false,
          });
        },
        error: function () {
          Swal.fire({
            icon: "error",
            title: "Failed to resend OTP",
            text: "Please try again later.",
          });
        },
      });
    });
  </script>
</body>
</html>
