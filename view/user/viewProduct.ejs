<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Listing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/user/viewProduct.css">
   
</head>

<body class="bg-white text-gray-800">

    <%- include("../../view/partials/user/header") %>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-center mt-4">
    <div class="relative w-1/2 md:w-1/3">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Search products..."
            class="w-full border px-3 py-2 rounded-md text-sm pr-10"
        />

        <!-- Clear Button -->
        <button 
            id="clearSearch"
            class="absolute right-3 top-2/3 -translate-y-1/2 text-black hover:text-gray-700 text-base hidden leading-none"
        >
            ✕
        </button>
    </div>
</div>




        <!-- Header/Breadcrumbs -->
        <div class="py-6">
           
        </div>

        <!-- Mobile Hamburger Button -->
        <button id="openFilterBtn"
            class="lg:hidden p-2 border rounded-md mb-4 flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            Filters
        </button>

        <!-- Main Content -->
        <div class="flex flex-col lg:flex-row gap-8 pb-12">

            <!-- LEFT FILTER SIDEBAR -->
            <aside id="filterSidebar"
                class="hidden lg:block filter-section lg:w-1/4 xl:w-1/5 bg-white border-r border-gray-200 lg:pr-6">

                <!-- Mobile Close Button -->
                <button id="closeFilterBtn" class="lg:hidden absolute right-4 top-4 text-gray-600 text-xl">
                    ✖
                </button>

                <h2 class="text-xl font-bold mb-6">Filters</h2>

                <!-- Category Filter -->
                <div class="mb-8 border-b pb-4">
                    <h3 class="text-lg font-semibold mb-3 flex justify-between items-center">
                        Category
                        <button class="text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                            </svg>
                        </button>   
                    </h3>
                    <div class="space-y-2">
                        <%category.map(data=>{%>
                        <label class="flex items-center text-sm">
                            <input name="category" value="<%=data._id%>" type="checkbox" class="categoryFilter rounded text-black h-4 w-4">
                            <span class="ml-2"><%=data.name%></span>
                        </label>
                        <%})%>
                    </div>
                </div>

                <!-- Brand Filter -->
                <div class="mb-8 border-b pb-4">    
                    <h3 class="text-lg font-semibold mb-3 flex justify-between items-center">
                        Brand
                        <button class="text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                            </svg>
                        </button>
                    </h3>
                    <div class="space-y-2">
                        <%brands.map(data=>{%>
                        <label class="flex items-center text-sm">
                            <input name="brand" value="<%=data._id%>" type="checkbox" class="brandFilter rounded text-black h-4 w-4">
                            <span class="ml-2"><%=data.brandName%></span>
                        </label>
                        <%})%>
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="mb-8 pb-4">
                    <h3 class="text-lg font-semibold mb-3 flex justify-between items-center">
                        Price
                        <button class="text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                            </svg>
                        </button>
                    </h3>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" value="0-999" class="priceFilter rounded text-black h-4 w-4">
                            <span class="ml-2">Below 1000</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" value="1000-1999" class="priceFilter rounded text-black h-4 w-4">
                            <span class="ml-2">Price 1000 to 2000</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" value="2000-2999" class="priceFilter rounded text-black h-4 w-4">
                            <span class="ml-2">Price 2000 to 3000</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" value="3000-4999" class="priceFilter rounded text-black h-4 w-4">
                            <span class="ml-2">Price 3000 to 5000</span>
                        </label>
                        <label class="flex items-center text-sm">       
                            <input type="checkbox" value="5000-9999" class="priceFilter rounded text-black h-4 w-4">
                            <span class="ml-2">Price 5000 to 10000</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" value="10000-19999" class="priceFilter rounded text-black h-4 w-4">
                            <span class="ml-2">Above 10000</span>
                        </label>
                    </div>
                </div>

            </aside>

            <!-- RIGHT COLUMN (Products) -->
            <main class="lg:w-3/4 xl:w-4/5">

                <!-- Sorting Bar -->
                <div class="flex items-center text-sm mb-6 border-b pb-3 overflow-x-auto whitespace-nowrap">
                    <span class="font-semibold text-gray-500 mr-4">Sort By</span>
                    <button class="text-gray-500 px-3 py-1 mr-4 hover:text-black" data-sort="low-high">
                        Price Low - High
                    </button>
                    <button class="text-gray-500 px-3 py-1 mr-4 hover:text-black" data-sort="high-low">
                        Price High - Low
                    </button>
                </div>

                <!-- Product Grid -->
                <div id="productContainer"
                    class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6">
                </div>

            </main>
        </div>
    </div>

    <!-- pagination -->
    <div id="pagination" class="flex justify-center mt-8 gap-2"></div>

    <%- include("../../view/partials/user/footer") %>

    <!-- JS for sidebar toggle -->
    <script>
        const openBtn = document.getElementById("openFilterBtn");
        const closeBtn = document.getElementById("closeFilterBtn");
        const sidebar = document.getElementById("filterSidebar");

        openBtn?.addEventListener("click", () => {
            sidebar.classList.add("mobile-active");
            sidebar.classList.remove("hidden");
        });

        closeBtn?.addEventListener("click", () => {
            sidebar.classList.remove("mobile-active");
            sidebar.classList.add("hidden");
        });


        const productContainer= document.getElementById('productContainer')
        const paginationContainer= document.getElementById('pagination')
        const searchInput= document.getElementById('searchInput')
        const clearSearch= document.getElementById('clearSearch')
        const categoryFilter= document.querySelectorAll('.categoryFilter')
        const brandFilter= document.querySelectorAll('.brandFilter')
        const sort= document.querySelectorAll("[data-sort]")
        const priceFilter= document.querySelectorAll('.priceFilter')



        let selectedCategories=[]
        let selectedbrands=[]
        let selectedPrice=[]
        let selectedSort=''
        let search=''
        let currentPage=1   
        let totalPage=1    

        async function fetchdata(){
            try{
            const queryString=new URLSearchParams({
                search,
                category:selectedCategories.join(","),
                brand:selectedbrands.join(","),
                price:selectedPrice.join(","),
                sort:selectedSort,
                page:currentPage
            }).toString()
           const res= await fetch(`/filterproduct?${queryString}`)
            const data=await res.json()
            console.log(data);
            
            if(data.success){
                
                totalPage= data.totalPage
                currentPage= data.currentPage
                renderProduct(data.product)
                renderPagination()
            }
            else{
                 productContainer.innerHTML = '<p class="text-center w-full py-8">No products found.</p>';
                 totalPage = 1;
                 currentPage = 1;
                 renderPagination();
                }
        }catch(err){
            paginationContainer.innerHTML=`<p class="text-center w-full py-8 text-red-500">Failed to load products.</p>`
            totalPage=1
            currentPage=1
        }
    }

        priceFilter.forEach(price=>{
            price.addEventListener('change',()=>{
                selectedPrice=[...priceFilter]
                .filter(val=>val.checked)
                .map(x=>x.value)
                currentPage=1
                fetchdata()
            })
        })

        categoryFilter.forEach(item=>{
            item.addEventListener('change',()=>{
                    selectedCategories= [...categoryFilter]
                    .filter(val=>val.checked).map(x=>x.value)
                    currentPage=1
                    fetchdata()
            }) 
         }) 

         brandFilter.forEach(item=>{
            item.addEventListener('change',()=>{
                    selectedbrands=[...brandFilter]
                    .filter(val=>val.checked)
                    .map(x=>x.value)
                    currentPage=1
                    fetchdata()
            })
         })

         sort.forEach((item)=>{
            item.addEventListener('click',()=>{
                selectedSort= item.dataset.sort
                currentPage=1
                fetchdata()
            })
         })


        function renderProduct(product){
  productContainer.innerHTML = product.map(data => `
    <div class="product-card bg-white rounded-lg overflow-hidden shadow-md flex flex-col h-full">
      <div class="w-full h-48 overflow-hidden">
       <a href="/productdetails/${data._id}"><img src="${data.productImage[0]}" class="w-full h-full object-cover" alt="${data.productName}"></a>
      </div>

      <div class="p-4 flex flex-col flex-1">
        <h3 class="font-semibold text-sm mb-1 truncate">${data.productName}</h3>
        <div class="text-xs text-yellow-500 mb-2">★★★★☆</div>

        <div class="text-sm font-bold">₹${data.variants[0].price}</div>

        <!-- Actions pushed to bottom -->
        <div class="mt-auto flex items-center gap-2 pt-3">
          <button class="flex-1 border border-black py-2 rounded-md text-sm hover:bg-black hover:text-white transition">
            Add to cart
          </button>

          <button class="w-10 h-10 border border-gray-300 rounded-md flex items-center justify-center hover:bg-gray-100">
            <svg class="w-5 h-5 text-gray-500 hover:text-red-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 21l-7.682-7.682a4.5 4.5 0 010-6.364z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  `).join("");
}


function renderPagination(){
    let paginationButtons="";
    for(let i=1;i<=totalPage;i++){
       paginationButtons +=` <button data-page="${i}" class="px-3 py-1 border rounded-md ${i === currentPage ? 'bg-black text-white' : 'bg-white'}">
            ${i}
        </button>`
    }

    paginationContainer.innerHTML=`
    <button id="prevBtn" class="px-3 py-1 border rounded-md ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}">
        Prev
    </button>

    ${paginationButtons}


    <button id="nextBtn" class="px-3 py-1 border rounded-md ${currentPage === totalPage ? 'opacity-50 cursor-not-allowed' : ''}">
        Next
    </button>

    `

    document.getElementById('prevBtn').addEventListener('click',()=>{
        if(currentPage >1){
            currentPage--
            fetchdata()
        }
    })
    document.getElementById('nextBtn').addEventListener('click',()=>{
        if(currentPage<totalPage){
            currentPage++
            fetchdata() 
        }
    })
    document.querySelectorAll("[data-page]").forEach(btn=>{
        btn.addEventListener('click',()=>{
            const page=Number(btn.getAttribute('data-page'))
            if(page !== currentPage){
                currentPage=page
                fetchdata()
            }
        })
    })
}


        let searchTimer;
        searchInput.addEventListener('input',()=>{

            if(searchInput.value.trim()){
                clearSearch.classList.remove('hidden')
            }else{
                clearSearch.classList.add('hidden')
            }

            clearTimeout(searchTimer)
            searchTimer=setTimeout(()=>{
                search= searchInput.value.trim()
                fetchdata()
            },400)
            
        })

        clearSearch.addEventListener('click',()=>{
            searchInput.value=''
            clearSearch.classList.add('hidden')

            search=''
            fetchdata()
        })
        fetchdata()

        

    </script>
</div>
</body>

</html>
